<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>出货申请查询</title>
    <link rel="stylesheet" href="static/ship-query.css">
    <link rel="stylesheet" href="static/pagination.css">
</head>
<body>
<div class="query-container">
    <form method="get" action="/ship_query" class="query-container">
        <label>产品条码：</label>
        <input type="text" name="search" placeholder="输入产品条码查询">
        <button type="submit">搜索</button>
    </form>
</div>

<table id="shipmentTable">
    <thead>
    <tr>
        <th>旧产品条码</th>
        <th>新产品标签</th>
        <th>FBA标签</th>
        <th>Shipping标签</th>
        <th>托盘标签</th>
        <th>装箱数据</th>
        <th>面单操作</th>
    </tr>
    </thead>
    <tbody>
    {% for r in records %}
    <tr data-id="{{ r.recordId }}">
        <td>{{ r.barcode }}</td>
        <td>
            {% for lbl in r.changeLabels %}
            <a href="/ship_query/file/view?url={{ lbl.url | urlencode }}" target="_blank">{{ lbl.name }}</a><br>
            {% endfor %}
        </td>
        <td>
            {% for lbl in r.fbaLabels %}
            <a href="/ship_query/file/view?url={{ lbl.url | urlencode }}" target="_blank">{{ lbl.name }}</a><br>
            {% endfor %}
        </td>
        <td>
            {% for lbl in r.shippingLabels %}
            <a href="/ship_query/file/view?url={{ lbl.url | urlencode }}" target="_blank">{{ lbl.name }}</a><br>
            {% endfor %}
        </td>
        <td>
            {% for lbl in r.palletLabels %}
            <a href="/ship_query/file/view?url={{ lbl.url | urlencode }}" target="_blank">{{ lbl.name }}</a><br>
            {% endfor %}
        </td>
        <td>
          <a href="javascript:void(0)" onclick="openPackingOverlay('{{ r.recordId }}')">完善</a>
        </td>
        <td>
            <a href="javascript:void(0)" onclick="handleClick('view', this)">查看</a>&nbsp;
            <a href="javascript:void(0)" onclick="handleClick('print', this)">打印</a>&nbsp;
            <a href="javascript:void(0)" onclick="handleClick('ship', this)">处理完成</a>
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="7">没有已处理的出货申请</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<div class="pagination">
    {% set qargs = query_args or {} %}

    {# 上一页 #}
    {% if page > 1 %}
    <a href="{{ url_for('ship_query.ship_query_page', page=page-1, **qargs) }}">上一页</a>
    {% else %}
    <span class="disabled">上一页</span>
    {% endif %}

    {# 当前页/总页数 #}
    <span>第 {{ page }} / {{ total_pages }} 页 (共 {{ total }} 条)</span>

    {# 下一页 #}
    {% if page < total_pages %}
    <a href="{{ url_for('ship_query.ship_query_page', page=page+1, **qargs) }}">下一页</a>
    {% else %}
    <span class="disabled">下一页</span>
    {% endif %}
</div>

<!-- ✅ 覆盖层 -->
<div id="overlay">
    <div id="overlay-content">
        <span class="overlay-close" onclick="closeOverlay()">✖</span>
        <div id="labelPreview" class="label-template">
            <!-- 这里由 JS 动态填充面单内容 -->
        </div>
        <button class="print-btn" onclick="printLabel()">打印面单</button>
    </div>
</div>


<!-- ✅ 装箱数据浮层（完善 / 修改） -->
<div id="packingOverlay" class="overlay">
  <div class="overlay-content">
    <span class="overlay-close" onclick="closePackingOverlay()">✖</span>

    <div class="form-container">
      <h2 id="packingTitle">完善装箱数据</h2>

      <form id="packingForm">
        <input type="hidden" id="recordId" />

        <div class="form-group">
          <label for="barcode">产品条码</label>
          <input type="text" id="barcode" name="barcode" readonly />
        </div>

        <div class="form-group">
          <label for="cartons">箱&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数</label>
          <input type="number" id="cartons" name="cartons" min="1" required />
        </div>

        <div class="form-group">
          <label for="qty">每箱数量</label>
          <input type="number" id="qty" name="qty" min="1" required />
        </div>

        <div class="form-group">
          <label for="weight">重量(LB)</label>
            <input type="number" step="0.01" id="weight" name="weight" required />
        </div>

        <div class="form-group">
          <label for="spec">箱&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;规</label>
          <input list="carton-options" id="spec" name="spec" placeholder="可选择或输入" required />
          <datalist id="carton-options">
            <option value="22x18x12">22x18x12-296</option>
            <option value="18x16x12">18x16x12-220</option>
          </datalist>
        </div>

        <div class="form-group">
          <label for="remark">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注</label>
          <textarea id="remark" name="remark" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    window.records = JSON.parse('{{ records | tojson | safe }}');
    window.recordMap = {};
    window.records.forEach(r => {
        window.recordMap[r.recordId] = r;
    });
</script>
<script src="static/ship-query.js"></script>
<script>
function formatTimestamp(ms) {
  const d = new Date(Number(ms));
  const pad = n => n.toString().padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} `
       + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

document.querySelectorAll(".time").forEach(el => {
  const ts = el.dataset.time;
  if (ts) {
    el.textContent = formatTimestamp(ts);
  }
});
</script>
</body>
</html>